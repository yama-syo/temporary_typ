<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0"/>
	<style>
	body{
		margin: 0;
		padding: 0;
		--fontS: 3rem;
		--lineH: calc(1 * var(--fontS));
		font-size: var(--fontS);
		line-height:var(--lineH);
		width:150px;
	}
	#inP{
		position: relative;
	}
	#caret{
		/* display: inline-block; */
		position: absolute;
		/* top: 0; */
		/* top: calc ( -1 * var(--gLineHPadding)); */
		/* top: var(--viewOffset); */
		/* top: calc(var(--fontPadding) + var(--viewLine)); */
		/* bottom: 0;
		left: 0;
		right: 0; */
		margin: 0 0 0 2px;
		/* margin-top: calc ( 10 * var(--gLineHPadding)); */
		/* margin: 0; */
		/* padding: 0; */
		background-color: rgba(220, 220, 250, 0.6);
		width: calc( var(--fontS) / 4 );
		height: calc(var(--fontS) * 1.5);
		animation: flash 0.8s linear infinite;
		/* vertical-align: middle; */
	}
	@keyframes flash {
		0% {
			opacity: 0.6;
		}
		50% {
			opacity: 0;
		}
		100% {
			opacity: 0.6;
		}
	}
	</style>
</head>
<body style=>
	<textarea id="tt">t</textarea>
	<!-- <div id="inn"> -->
		<div style="position: relative;">
			<div id="inP" tabindex="-1" contenteditable=true>
				<span>あ</span><span>か</span><span>ち</span><span>ょ</span><span>ょ</span><span>ち</span><span>か</span><span class="L">あ</span></div>

				<!-- <div id="caret"></div> -->
			</div>
		<div>
		<div>----------------------------</div>
		<div id="con" tabindex="-1" contenteditable=true><span>あ</span><span>か</span><span>ち</span><span>ょ</span><span>ょ</span><span>ち</span><span>か</span><span>あ</span></div>
		<!-- <div id="inP" style="width:100%;height:10vh;" contenteditable=false tabindex="0"><span>q</span><span>Q</span><span>I</span><span>y<span id="caret"></span></span></div> -->
		<!-- <span>a</span><span>b</span><span contenteditable="true"></span> -->
</body>
<!-- https://qiita.com/Pell/items/def5860ccdef1ccdfe1c -->
<!-- https://ascii.jp/elem/000/001/510/1510676/ -->
<script>
// document.addEventListener("keydown", e =>{
// 	console.log("keydown@document_event:", document.activeElement, e);
// 	// if(e.code == "CapLock"){
// 	// 	imeOn = true;
// 	// }
// },{capture: true});
let num = 0;
let keyDown = false;
let imeOn = false;
const inP = document.getElementById("inP");
const con = document.getElementById("con");
const caretEle = document.createElement("div");
caretEle.id = "caret";
inP.parentNode.appendChild(caretEle);
const inPX = inP.getClientRects()[0].x;
const inPY = inP.getClientRects()[0].y;
console.debug("inPX", inPX, "inPY", inPY, inP.getClientRects()[0]);
// https://github.com/RobertWHurst/KeyboardJS
// https://github.com/RobertWHurst/Keystrokes
function customSpan(se, ime) {
	console.log("customSpan: "
	,"inP.selectionStart:", inP.selectionStart
	,"inP.textContent", inP.textContent
	,"inP.textContent.length", inP.textContent.length
	,"se.focusNode:", se.focusNode
	,"se.focusOffset", se.focusOffset
	,"se.focusNode.className", se.focusNode.className
	// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
	,"se.focusNode.contenteditable", se.focusNode.isContentEditable
	,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
	,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
	// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
	// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
	);
	const s = document.createElement("span");
	if(se.focusOffset == 0){
		inP.prepend(s);
	}else{
		se.focusNode.parentElement.after(s);
	}
	if (ime){
		s.contentEditable = true;
		s.addEventListener("keydown", e =>{
			// e.stopImmediatePropagation();//親へ伝える必要がある
			// e.preventDefault();
			if(e.isComposing||e.key == "Process" || e.keyCode == 229){
				e.stopImmediatePropagation();
				this.imeOn = true;
			}else{
				this.imeOn = false;
			}
			const se = getSelection();
			console.log("keydown@in-p_event: ", e
			,"e.key: ", e.key
			,"e.key: ", e.code
			,"isComposing:", e.isComposing
			,"inP.selectionStart:", inP.selectionStart
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
			);
		});
		s.addEventListener("compositionstart" , e =>{
			// e.stopImmediatePropagation();
			const se = getSelection();
			console.log("compositionend@span_event: ", e
			,"e.key: ", e.key
			,"e.key: ", e.code
			,"isComposing:", e.isComposing
			,"inP.selectionStart:", inP.selectionStart
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
			);
		});
		s.addEventListener("compositionend" , e =>{
			debugger;
			const se = getSelection();
			console.log("compositionend@span_event: ", e
			,"e.key: ", e.key
			,"e.key: ", e.code
			,"isComposing:", e.isComposing
			,"inP.selectionStart:", inP.selectionStart
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
			);
			inP.contentEditable = true;
			inP.focus();
			// s.contentEditable = false;
			s.removeAttribute("contenteditable");
			// e.stopImmediatePropagation();
			// const in_p = this.cloneNode(false)
			// this.after(this.cloneNode(false));
			// in_p.focus();
			if(e.data.length == 0){
				s.remove();
			}
		});
		s.addEventListener("input", e => {
			// e.stopImmediatePropagation();
			const se = getSelection();

			console.log("input@span_event:: ", e
			,"isComposing:", e.isComposing
			,"inP.selectionStart:", inP.selectionStart
			// ,"CaretPos", getCaretPosition()
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
			);
		});
		s.addEventListener("keyup", e =>{
			// e.stopImmediatePropagation();
			// e.preventDefault();
			// if(e.isComposing||e.key == "Process" || e.keyCode == 229){
			// 	this.imeOn = true;
			// }else{
			// 	this.imeOn = false;
			// }
			const se = getSelection();
			console.log("keyup@span_event: ", e
			,"e.key: ", e.key
			,"e.key: ", e.code
			,"isComposing:", e.isComposing
			,"inP.selectionStart:", inP.selectionStart
			// ,"CaretPos", getCaretPosition()
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
			);
		});
		inP.contentEditable = false;
		s.focus();
		console.log("imeStart@span_event: "
			,"inP.selectionStart:", inP.selectionStart
			// ,"CaretPos", getCaretPosition()
			,"inP.textContent", inP.textContent
			,"inP.textContent.length", inP.textContent.length
			,"se.focusNode:", se.focusNode
			,"se.focusOffset", se.focusOffset
			,"se.focusNode.className", se.focusNode.className
			// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
			,"se.focusNode.contenteditable", se.focusNode.isContentEditable
			,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
			,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
			// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
			// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
		);
		// debugger;
	}
	return s;
}

inP.addEventListener("click", e => {
	const se = getSelection();
	console.debug("event@click:", se.focusNode);
    let range = se.getRangeAt(0);
	let rect;
	if(se.focusNode.nodeType == Node.TEXT_NODE){
		rect = se.focusNode.parentElement.getClientRects()[0];
	}else{
		rect = se.focusNode.getClientRects()[0];
	}
	console.debug("range:", range, "rect:" ,rect);
	// caretEle.style.left = rect.x + rect.width - inPX + "px";
	// caretEle.style.top = rect.y - inPY + "px";
	// let s = document.createElement("in-p");
	// se.focusNode.parentElement.after(s);
	// s.focus();
	// console.debug(inP.lastChild);
	// inP.focus();
	// if (inP.lastChild == null){
	// 	//最後の要素にゼロ空白文字をもつ要素を作る
	// 	// inP.innerHTML="<span>&#x200B;</span>"
	// 	inP.innerHTML="<span id='i' contenteditable='true'></span>"
	// }
	// if (inP.lastChild != null){
	// 	//最後の要素の次の文字へフォーカス
	// 	// const range = document.createRange();
	// 	// range.setStart(inP.lastChild, 0);
	// 	// range.setEnd(inP.lastChild, 0);
	// 	// const se = getSelection();
	// 	// // debugger;
	// 	// se.removeAllRanges();
	// 	// se.addRange(range);
	// 	let s = document.createElement("span");
	// 	s.id="i";
	// 	s.contentEditable = true;
	// 	inP.appendChild(s);
	// 	s.focus();
	// }
});
// https://www.google.co.jp/search?q=%22chromium%22+capture+input+method+editor+key&ei=QdnUY8iuDpay2roPsea3-AQ&ved=0ahUKEwiI066A6en8AhUWmVYBHTHzDU8Q4dUDCA8&uact=5&oq=%22chromium%22+capture+input+method+editor+key&gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIFCAAQogQyBQgAEKIEMgoIABDxBBAeEKIEMgUIABCiBDoKCAAQRxDWBBCwA0oECEEYAEoECEYYAFDzC1jOEmDnFGgBcAF4AIABZIgBuwGSAQMxLjGYAQCgAQHIAQrAAQE&sclient=gws-wiz-serp
// https://developer.chrome.com/docs/extensions/reference/input_ime/
// https://stackoverflow.com/questions/11392470/detect-if-capslock-is-down
// https://unixpapa.com/js/key.html
// https://stackoverflow.com/questions/39016292/keydown-event-is-not-fired-for-capslock-in-mac
// https://aruhito.net/2021-12-04-note-change-ime-with-only-capslock/
// https://dulunoj.com/2021/01/02/ime%E3%81%AE%E3%82%AA%E3%83%B3%E3%83%BB%E3%82%AA%E3%83%95%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%EF%BC%8Bcapslock%EF%BC%8Bus%E9%85%8D%E5%88%97%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E5%95%8F/
inP.addEventListener('keydown', e => {
	//キーダウンフラグ
	keyDown = true;
	const se = getSelection();

	console.log("keydown@inp_event: ", e
		,"e.key: ", e.key
		,"e.key: ", e.code
		,"isComposing:", e.isComposing
		,"keyDown:", keyDown
		,"inP.selectionStart:", inP.selectionStart
		// ,"CaretPos", getCaretPosition()
		,"inP.textContent", inP.textContent
		,"inP.textContent.length", inP.textContent.length
		,"se.focusNode:", se.focusNode
		,"se.focusOffset", se.focusOffset
		,"se.focusNode.className", se.focusNode.className
		// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
		,"se.focusNode.contenteditable", se.focusNode.isContentEditable
		,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
		,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
		// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
		// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
		// ,"typ.firstChild.innerHTML", typ.firstChild.innerHTML
	);
// 	// https://stackoverflow.com/questions/5598743/finding-elements-position-relative-to-the-document
// 	// https://stackoverflow.com/questions/44617545/moving-an-element-in-js
// 	// https://www.softel.co.jp/blogs/tech/archives/3049
// 	// https://qiita.com/18kondo/items/3c101d66f7efc4bbe57b
// 	// https://lab.syncer.jp/Web/JavaScript/Snippet/16/

	// con.dispatchEvent(new KeyboardEvent("keydown", e));
	if(37 <= e.keyCode && e.keyCode <= 40 || e.code == "Backspace" || e.code == "Delete"){
		if(inP.contentEditable == "false"){
			inP.contentEditable = true;
			inP.focus();
		}
	}else if(e.code == "CapsLock"|| e.code == "Backquote"){
		// inP.contentEditable = false;
		// setTimeout(() =>{
		// 	inP.contentEditable = false;
		// 	console.debug("IMEToggle");
		// }, 1500);
	}else if(!e.isComposing && e.keyCode != 229 && e.key != "Process"){
		// if(inP.contentEditable == "true"){
		// 	inP.contentEditable = false;
		// 	inP.focus();
		// }
	}else{
		// inP.contentEditable = false;
	}
});
inP.addEventListener('compositionstart', e => {
	const se = getSelection();

	console.log("compositionstart@event: ", e
	,"e.key: ", e.key
	,"e.key: ", e.code
	,"isComposing:", e.isComposing
	,"keyDown:", keyDown
	,"inP.selectionStart:", inP.selectionStart
	// ,"CaretPos", getCaretPosition()
	,"inP.textContent", inP.textContent
	,"inP.textContent.length", inP.textContent.length
	,"se.focusNode:", se.focusNode
	,"se.focusOffset", se.focusOffset
	,"se.focusNode.className", se.focusNode.className
	// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
	,"se.focusNode.contenteditable", se.focusNode.isContentEditable
	,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
	,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
	// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
	// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
	// ,"typ.firstChild.innerHTML", typ.firstChild.innerHTML
	);
	const s = customSpan(se, true);
	// inP.contentEditable = false;

	// if(e.key == "Process" || e.keyCode == 229 ){
	// 		if(se.focusNode.nodeType != Node.TEXT_NODE){
	// 			let s = document.createElement("in-p");
	// 			console.log(s);
	// 			inP.appendChild(s);
	// 			s.focus();
	// 		}
	// 	}else{
	// 		if(se.focusNode.nodeType == Node.TEXT_NODE){
	// 			if(se.focusNode.parentNode === inP.lastChild){
	// 				let s = document.createElement("in-p");
	// 				console.log(s);
	// 				inP.appendChild(s);
	// 				s.focus();
	// 			}
	// 		}else{
	// 			if(se.focusNode === inP.lastChild){
	// 				let s = document.createElement("in-p");
	// 				console.log(s);
	// 				inP.appendChild(s);
	// 				// s.focus();
	// 			}
	// 		}
	// 	}
	// }
});
inP.addEventListener("input", e => {
	const se = getSelection();

	console.log("input@inp_event: ", e
	,"e.key: ", e.key
	,"e.key: ", e.code
	,"isComposing:", e.isComposing
	,"keyDown:", keyDown
	,"inP.selectionStart:", inP.selectionStart
	// ,"CaretPos", getCaretPosition()
	,"inP.textContent", inP.textContent
	,"inP.textContent.length", inP.textContent.length
	,"se.focusNode:", se.focusNode
	,"se.focusOffset", se.focusOffset
	,"se.focusNode.className", se.focusNode.className
	// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
	,"se.focusNode.contenteditable", se.focusNode.isContentEditable
	,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
	,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
	// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
	// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
	// ,"typ.firstChild.innerHTML", typ.firstChild.innerHTML
	);
	// inP.contentEditable = false;
});
inP.addEventListener("compositionend", e =>{
	console.debug("compositionend@event");
	const se = getSelection();
	// const range = document.createRange();
	// range.setStart(s, 0);
	// range.setEnd(s, 0);
	// se.removeAllRanges();
	// se.addRange(range);
	// inP.contentEditable = false;
});
inP.addEventListener('keyup', e => {
	const se = getSelection();
	console.log("keyup@event: ", e
	,"e.key: ", e.key
	,"e.key: ", e.code
	,"isComposing:", e.isComposing
	,"keyDown:", keyDown
	,"inP.selectionStart:", inP.selectionStart
	// ,"CaretPos", getCaretPosition()
	,"inP.textContent", inP.textContent
	,"inP.textContent.length", inP.textContent.length
	,"se.focusNode:", se.focusNode
	,"se.focusOffset", se.focusOffset
	,"se.focusNode.className", se.focusNode.className
	// ," / se.focusNode.innerHTML", se.focusNode.innerHTML
	,"se.focusNode.contenteditable", se.focusNode.isContentEditable
	,"se.focusNode.parentNode.className", se.focusNode.parentElement.className
	,"se.focusNode.parentNode.nextSibling", se.focusNode.parentNode.nextSibling
	// ," / se.focusNode.parentNode.textContent", se.focusNode.parentElement.textContent
	// , " / se.focusNode.textContent.length", se.focusNode.textContent.length
	// ,"typ.firstChild.innerHTML", typ.firstChild.innerHTML
	);
	// debugger;
	// inP.contentEditable = false;
});

</script>
</html>
